!function(t,e){if("function"==typeof define&&define.amd)define(["exports"],e);else if("undefined"!=typeof exports)e(exports);else{var o={exports:{}};e(o.exports),t.JSWebrtc=o.exports}}("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:this,(function(t){var e={Player:null,VideoElement:null,CreateVideoElements:function(){for(var t=document.querySelectorAll(".jswebrtc"),o=0;o<t.length;o++)new e.VideoElement(t[o])},FillQuery:function(t,e){if(e.user_query={},0!=t.length){t.indexOf("?")>=0&&(t=t.split("?")[1]);for(var o=t.split("&"),n=0;n<o.length;n++){var i=o[n].split("=");e[i[0]]=i[1],e.user_query[i[0]]=i[1]}e.domain&&(e.vhost=e.domain)}},ParseUrl:function(t){var o=document.createElement("a");o.href=t.replace("rtmp://","http://").replace("webrtc://",window.location.protocol+"//").replace("rtc://",window.location.protocol+"//");var n=o.hostname,i=o.pathname.substr(1,o.pathname.lastIndexOf("/")-1),s=o.pathname.substr(o.pathname.lastIndexOf("/")+1);if((i=i.replace("...vhost...","?vhost=")).indexOf("?")>=0){var a=i.substr(i.indexOf("?"));i=i.substr(0,i.indexOf("?")),a.indexOf("vhost=")>0&&(n=a.substr(a.indexOf("vhost=")+6)).indexOf("&")>0&&(n=n.substr(0,n.indexOf("&")))}o.hostname==n&&/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/.test(o.hostname)&&(n="__defaultVhost__");var r="rtmp";t.indexOf("://")>0&&(r=t.substr(0,t.indexOf("://")));var p=o.port;p||("http"===r?p=80:"https"===r?p=443:"rtmp"===r?p=1935:"webrtc"!==r&&"rtc"!==r||(p=0==window.location.protocol.search("https")?443:1985)),0==window.location.protocol.search("https")&&(t=t.replace("http://","https://"));var l={url:t,schema:r,server:o.hostname,port:p,vhost:n,app:i,stream:s};return e.FillQuery(o.search,l),l},HttpPost:function(t,e){return new Promise((function(o,n){var i=new XMLHttpRequest;i.onreadystatechange=function(){if(4===i.readyState&&i.status>=200&&i.status<300){var t=JSON.parse(i.responseText);i.onreadystatechange=new Function,i=null,o(t)}},i.open("POST",t,!0),i.responseType="text",i.setRequestHeader("Content-Type","application/json"),i.send(e)}))}};return"complete"===document.readyState?e.CreateVideoElements():document.addEventListener("DOMContentLoaded",e.CreateVideoElements),e.VideoElement=function(){"use strict";var t=function(o){var n=o.dataset.url;if(!n)throw"VideoElement has no `data-url` attribute";var i=function(t,e){for(var o in e)t.style[o]=e[o]};this.container=o,i(this.container,{display:"inline-block",position:"relative",minWidth:"80px",minHeight:"80px"}),this.video=document.createElement("video"),this.video.width=960,this.video.height=540,i(this.video,{display:"block",width:"100%"}),this.container.appendChild(this.video),this.playButton=document.createElement("div"),this.playButton.innerHTML=t.PLAY_BUTTON,i(this.playButton,{zIndex:2,position:"absolute",top:"0",bottom:"0",left:"0",right:"0",maxWidth:"75px",maxHeight:"75px",margin:"auto",opacity:"0.7",cursor:"pointer"}),this.container.appendChild(this.playButton);var s={video:this.video};for(var a in o.dataset)try{s[a]=JSON.parse(o.dataset[a])}catch(t){s[a]=o.dataset[a]}if(this.player=new e.Player(n,s),o.playerInstance=this.player,s.poster&&!s.autoplay&&(s.decodeFirstFrame=!1,this.poster=new Image,this.poster.src=s.poster,this.poster.addEventListener("load",this.posterLoaded),i(this.poster,{display:"block",zIndex:1,position:"absolute",top:0,left:0,bottom:0,right:0}),this.container.appendChild(this.poster)),this.player.options.streaming||this.container.addEventListener("click",this.onClick.bind(this)),s.autoplay&&(this.playButton.style.display="none"),this.player.audioOut&&!this.player.audioOut.unlocked){var r=this.container;s.autoplay&&(this.unmuteButton=document.createElement("div"),this.unmuteButton.innerHTML=t.UNMUTE_BUTTON,i(this.unmuteButton,{zIndex:2,position:"absolute",bottom:"10px",right:"20px",width:"75px",height:"75px",margin:"auto",opacity:"0.7",cursor:"pointer"}),this.container.appendChild(this.unmuteButton),r=this.unmuteButton),this.unlockAudioBound=this.onUnlockAudio.bind(this,r),r.addEventListener("touchstart",this.unlockAudioBound,!1),r.addEventListener("click",this.unlockAudioBound,!0)}};return t.prototype.onUnlockAudio=function(t,e){this.unmuteButton&&(e.preventDefault(),e.stopPropagation()),this.player.audioOut.unlock(function(){this.unmuteButton&&(this.unmuteButton.style.display="none"),t.removeEventListener("touchstart",this.unlockAudioBound),t.removeEventListener("click",this.unlockAudioBound)}.bind(this))},t.prototype.onClick=function(t){this.player.isPlaying?(this.player.pause(),this.playButton.style.display="block"):(this.player.play(),this.playButton.style.display="none",this.poster&&(this.poster.style.display="none"))},t.PLAY_BUTTON='<svg style="max-width: 75px; max-height: 75px;" viewBox="0 0 200 200" alt="Play video"><circle cx="100" cy="100" r="90" fill="none" stroke-width="15" stroke="#fff"/><polygon points="70, 55 70, 145 145, 100" fill="#fff"/></svg>',t.UNMUTE_BUTTON='<svg style="max-width: 75px; max-height: 75px;" viewBox="0 0 75 75"><polygon class="audio-speaker" stroke="none" fill="#fff" points="39,13 22,28 6,28 6,47 21,47 39,62 39,13"/><g stroke="#fff" stroke-width="5"><path d="M 49,50 69,26"/><path d="M 69,50 49,26"/></g></svg>',t}(),e.Player=function(){"use strict";var t=function(t,o){if(this.options=o||{},!this.options.video)throw"VideoElement is null";this.proxy=this.options.proxy||"https://mcloudpush.cmc.zju.edu.cn:10443/player",this.urlParams=e.ParseUrl(t),this.pc=null,this.autoplay=!!o.autoplay||!1,this.paused=!0,this.startLoading()};return t.prototype.startLoading=function(){var t=this;t.pc&&t.pc.close(),t.pc=new RTCPeerConnection(null),t.pc.addEventListener("connectionstatechange",(function(){console.log("pull status ".concat(t.pc.connectionState)),"failed"===t.pc.connectionState&&t.startLoading()})),t.pc.ontrack=function(e){t.options.video.srcObject=e.streams[0],console.log(e.streams[0].getVideoTracks()[0])},t.pc.addTransceiver("audio",{direction:"recvonly"}),t.pc.addTransceiver("video",{direction:"recvonly"}),t.pc.createOffer().then((function(e){return t.pc.setLocalDescription(e).then((function(){return e}))})).then((function(o){return new Promise((function(n,i){console.log(t.urlParams.url);var s={url:t.urlParams.url,clientip:null,sdp:o.sdp};console.log("--------------------",t.proxy),e.HttpPost(t.proxy,JSON.stringify(s)).then((function(t){n(t.sdp)}),(function(t){i(t)}))}))})).then((function(e){return console.log(e),t.pc.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:e}))})).catch((function(t){throw console.log("throw reason error:",t),t})),this.autoplay&&this.play()},t.prototype.play=function(t){this.animationId||(this.animationId=requestAnimationFrame(this.update.bind(this)),this.paused=!1)},t.prototype.pause=function(t){this.paused||(cancelAnimationFrame(this.animationId),this.animationId=null,this.isPlaying=!1,this.paused=!0,this.options.video.pause(),this.options.onPause&&this.options.onPause(this))},t.prototype.stop=function(t){this.pause(),console.log("当前pc",this.pc)},t.prototype.destroy=function(){this.pc&&this.pc.close()&&this.pc.destroy(),this.pc=null,this.audioOut&&this.audioOut.destroy()},t.prototype.changeVideo=function(t){this.options.video=t,console.log("切换后的video",this.options),this.pc.ontrack=function(t){this.options.video.srcObject=t.streams[0]},this.play()},t.prototype.update=function(){var t=this;this.animationId=requestAnimationFrame(this.update.bind(this)),this.options.video.readyState<4||this.isPlaying||(this.isPlaying=!0,this.options.video.play().then().catch((function(e){console.error(e),t.options.onError&&t.options.onError(t,e)})),this.options.onPlay&&this.options.onPlay(this))},t}(),t.JSWebrtc=e,t}));